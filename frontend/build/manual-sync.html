<!DOCTYPE html>
<html>
<head>
    <title>Manual Firestore Sync</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1565c0;
        }
        .log {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Manual Firestore Sync Tool</h1>
        <p>Use this tool to manually sync purchases from localStorage to Firestore.</p>
        
        <button onclick="checkLocalStorage()">1. Check localStorage</button>
        <button onclick="syncToFirestore()">2. Sync to Firestore</button>
        <button onclick="checkFirestore()">3. Check Firestore</button>
        <button onclick="clearLog()">Clear Log</button>
        
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, setDoc, serverTimestamp, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "XsxVvIS4mIRSzDzG2RtsbJ_I1p25-rjuupbwWCffz6g",
            authDomain: "clickalinks-frontend.firebaseapp.com",
            projectId: "clickalinks-frontend",
            storageBucket: "clickalinks-frontend.firebasestorage.app",
            messagingSenderId: "568043553622",
            appId: "1:568043553622:web:d8e928c8b26e2847e50cf7"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<div class="${className}">${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        window.checkLocalStorage = () => {
            log('=== CHECKING LOCALSTORAGE ===', 'info');
            
            const squarePurchases = JSON.parse(localStorage.getItem('squarePurchases') || '{}');
            const pendingPurchases = JSON.parse(localStorage.getItem('pendingPurchases') || '{}');
            const businessFormData = JSON.parse(localStorage.getItem('businessFormData') || '{}');
            
            log(`squarePurchases: ${Object.keys(squarePurchases).length} entries`, 'info');
            Object.entries(squarePurchases).forEach(([key, value]) => {
                log(`  Square ${key}: ${JSON.stringify(value, null, 2)}`, 'info');
            });
            
            log(`pendingPurchases: ${Object.keys(pendingPurchases).length} entries`, 'info');
            Object.entries(pendingPurchases).forEach(([key, value]) => {
                log(`  Session ${key}: Square ${value.squareNumber || 'N/A'}`, 'info');
            });
            
            log(`businessFormData: ${JSON.stringify(businessFormData, null, 2)}`, 'info');
            
            // Check logo paths
            for (let i = 1; i <= 2000; i++) {
                const logoPath = localStorage.getItem(`logoPath_${i}`);
                if (logoPath) {
                    log(`logoPath_${i}: ${logoPath}`, 'info');
                }
            }
        };
        
        window.syncToFirestore = async () => {
            log('=== SYNCING TO FIRESTORE ===', 'info');
            
            const squarePurchases = JSON.parse(localStorage.getItem('squarePurchases') || '{}');
            const pendingPurchases = JSON.parse(localStorage.getItem('pendingPurchases') || '{}');
            const businessFormData = JSON.parse(localStorage.getItem('businessFormData') || '{}');
            
            let savedCount = 0;
            
            // Process squarePurchases
            for (const [squareNumber, purchase] of Object.entries(squarePurchases)) {
                try {
                    const squareNum = parseInt(squareNumber);
                    if (!squareNum) continue;
                    
                    // Check if already exists
                    const checkSnapshot = await getDocs(
                        query(collection(db, 'purchasedSquares'), where('squareNumber', '==', squareNum))
                    );
                    
                    if (checkSnapshot.empty) {
                        const logoPath = localStorage.getItem(`logoPath_${squareNumber}`);
                        
                        const dataToSave = {
                            status: 'active',
                            businessName: purchase.businessName || businessFormData.name,
                            logoData: purchase.logoData || businessFormData.logoData || null,
                            dealLink: purchase.website || purchase.dealLink || businessFormData.website || '',
                            contactEmail: purchase.contactEmail || businessFormData.email || '',
                            startDate: purchase.startDate || new Date().toISOString(),
                            endDate: purchase.endDate || new Date(Date.now() + (purchase.duration || 30) * 24 * 60 * 60 * 1000).toISOString(),
                            amount: purchase.amount || purchase.finalAmount || 10,
                            duration: purchase.duration || purchase.selectedDuration || 30,
                            transactionId: purchase.transactionId || purchase.sessionId || '',
                            purchaseDate: purchase.purchaseDate || new Date().toISOString(),
                            paymentStatus: 'paid',
                            storageType: (purchase.logoData || businessFormData.logoData || '').includes('firebasestorage') ? 'firebase' : 'local',
                            storagePath: logoPath || purchase.storagePath || null,
                            squareNumber: squareNum,
                            pageNumber: purchase.pageNumber || businessFormData.pageNumber || 1,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };
                        
                        await setDoc(doc(db, 'purchasedSquares', squareNumber.toString()), dataToSave);
                        log(`âœ… Saved square ${squareNumber} to Firestore`, 'success');
                        savedCount++;
                    } else {
                        log(`â­ï¸ Square ${squareNumber} already in Firestore`, 'info');
                    }
                } catch (error) {
                    log(`âŒ Error saving square ${squareNumber}: ${error.message}`, 'error');
                    if (error.code === 'permission-denied') {
                        log('ðŸš¨ PERMISSION DENIED: Check Firestore security rules!', 'error');
                    }
                }
            }
            
            log(`=== SYNC COMPLETE: ${savedCount} purchases saved ===`, savedCount > 0 ? 'success' : 'info');
        };
        
        window.checkFirestore = async () => {
            log('=== CHECKING FIRESTORE ===', 'info');
            
            try {
                const snapshot = await getDocs(collection(db, 'purchasedSquares'));
                log(`Total documents: ${snapshot.size}`, 'info');
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    log(`Document ${doc.id}: Square ${data.squareNumber}, Status: ${data.status}, Has Logo: ${!!data.logoData}`, 'info');
                });
            } catch (error) {
                log(`âŒ Error checking Firestore: ${error.message}`, 'error');
            }
        };
        
        window.clearLog = () => {
            document.getElementById('log').innerHTML = '';
        };
    </script>
</body>
</html>

